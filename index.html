<!DOCTYPE html>
<html>

<head>    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-116298013-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-116298013-2', { 'optimize_id': 'GTM-58H7MF6'});
    </script>


    <script src="https://www.gstatic.com/firebasejs/5.8.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.3/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.3/firebase-auth.js"></script>
    <script>
        
        firebase.initializeApp({
            'messagingSenderId': '961426606911'
        });
        
        const messaging = firebase.messaging();
        
        function initFirebaseMessagingRegistration() {
            messaging
                .requestPermission()
                .then(function () {
                    messageElement.innerHTML = "Got notification permission";
                    console.log("Got notification permission");
                    return messaging.getToken();
                })
                .then(function (token) {
                    tokenElement.innerHTML = "Token is " + token;
                    send_token = token;
                })
                .catch(function (err) {
                    errorElement.innerHTML = "Error: " + err;
                    console.log("Didn't get notification permission", err);
                });
        }
        
        messaging.onMessage(function (payload) {
            console.log("Message received. ", JSON.stringify(payload));
            navigator.serviceWorker.register('firebase-messaging-sw.js');
            navigator.serviceWorker.ready.then(function(registration) {
                payload.data.data = JSON.parse(JSON.stringify(payload.data));
                registration.showNotification(payload.data.title, payload.data);
            }).catch(function(error) {
                console.log('ServiceWorker registration failed', error);
            });
        });
        
        messaging.onTokenRefresh(function () {
            messaging.getToken()
                .then(function (refreshedToken) {
                    console.log('Token refreshed.');
                    tokenElement.innerHTML = "Token is " + refreshedToken;
                    send_token = refreshedToken;
                }).catch(function (err) {
                    errorElement.innerHTML = "Error: " + err;
                    console.log('Unable to retrieve refreshed token ', err);
                });
        });
        
    </script>
</head>

<body>
    <h1>Test web-push page</h1>
    <div id="token" style="color:lightblue"></div>
    <div id="message" style="color:lightblue"></div>
    <div id="notification" style="color:green"></div>
    <div id="error" style="color:red"></div>
    <script>
        messageElement = document.getElementById("message")
        tokenElement = document.getElementById("token")
        notificationElement = document.getElementById("notification")
        errorElement = document.getElementById("error")
    </script>
    <button onclick="initFirebaseMessagingRegistration()">Enable Firebase Messaging</button>
</body>

</html>
