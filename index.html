<!DOCTYPE html>
<html>

<head>
    <script src="https://www.gstatic.com/firebasejs/5.8.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.3/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.3/firebase-auth.js"></script>
    <script>
        firebase.initializeApp({
            'messagingSenderId': '961426606911'
        });
        const messaging = firebase.messaging();
        function initFirebaseMessagingRegistration() {
            messaging
                .requestPermission()
                .then(function () {
                    messageElement.innerHTML = "Got notification permission";
                    console.log("Got notification permission");
                    return messaging.getToken();
                })
                .then(function (token) {
                    // print the token on the HTML page
                    tokenElement.innerHTML = "Token is " + token;
                    send_token = token;
                })
                .catch(function (err) {
                    errorElement.innerHTML = "Error: " + err;
                    console.log("Didn't get notification permission", err);
                });
        }
        messaging.onMessage(function (payload) {
            console.log("Message received. ", JSON.stringify(payload));
            navigator.serviceWorker.register('firebase-messaging-sw.js');
            navigator.serviceWorker.ready.then(function(registration) {
                payload.data.data = JSON.parse(JSON.stringify(payload.data));
                registration.showNotification(payload.data.title, payload.data);
            }).catch(function(error) {
                console.log('ServiceWorker registration failed', error);
            });
            
            
            const notification = JSON.parse(payload.data.notification);
    // Customize notification here
    const notificationTitle = notification.title;
    const notificationOptions = {
        body: notification.body,
        icon: notification.icon
    };

    return self.registration.showNotification(notificationTitle,
        notificationOptions);
            
        });
        messaging.onTokenRefresh(function () {
            messaging.getToken()
                .then(function (refreshedToken) {
                    console.log('Token refreshed.');
                    tokenElement.innerHTML = "Token is " + refreshedToken;
                    send_token = refreshedToken;
                }).catch(function (err) {
                    errorElement.innerHTML = "Error: " + err;
                    console.log('Unable to retrieve refreshed token ', err);
                });
        });
        
    function sendToRTDM() {
        var xhr = new XMLHttpRequest();
        var RTDMhost = document.getElementById("RTDMhost").value;
        var title = document.getElementById("title").value;
        var body = document.getElementById("body").value;
        var icon = document.getElementById("icon").value;
        url = 'http://' + RTDMhost + 'RTDM/rest/runtime/decisions/webPUSH';
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-type', 'application/vnd.sas.decision.request+json');
        xhr.onload = function () {
            console.log(this.responseText);
        };
        xhr.send(JSON.stringify({
            "correlationId": "0",
            "clientTimeZone": "EST",
            "version": 1,
            "inputs": {
                "token": send_token,
                "title": title,
                "text": body,
                "icon": icon
            }
        }));  
    }
    </script>
</head>

<body>
    <h1>Test page</h1>
    <div id="token" style="color:lightblue"></div>
    <div id="message" style="color:lightblue"></div>
    <div id="notification" style="color:green"></div>
    <div id="error" style="color:red"></div>
    <script>
        messageElement = document.getElementById("message")
        tokenElement = document.getElementById("token")
        notificationElement = document.getElementById("notification")
        errorElement = document.getElementById("error")
        var send_token = "";
    </script>
    <button onclick="initFirebaseMessagingRegistration()">Enable Firebase Messaging</button>
    <form>
        <p><b>Trigger WEB-push</b></p>
        RTDM host URL</br>
        <input id="RTDMhost" name="RTDMhost"></br></br>
        <input id="title" name="title">Push Title</br>
        <input id="body" name="body">Push Text</br>
        <input id="icon" name="icon">Icon URL</br>
        <button onclick="sendToRTDM()">Trigger push</button>
    </form>
</body>

</html>
